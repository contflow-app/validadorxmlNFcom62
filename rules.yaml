#############################################
# rules.yaml
# Regras de validação para o validador NFCom 62
#
# Fontes:
# - MOC NFCom – Anexo II – DANFE-COM (campos obrigatórios no XML)
# - NFCom Checklist Regime Normal (Lucro Real/Presumido)
# - NFCom Checklist Simples Nacional
# - Regras internas do escritório (CFOP PF/PJ, SVA com CFOP zerado etc.)
#
# OBS:
#  - Os XPaths podem precisar de pequenos ajustes conforme o layout exato
#    do XML NFCom (tags e namespaces da sua UF/fornecedor de sistema).
#  - As regras marcadas como "alerta" podem ser afinadas depois.
#############################################

#############################################
# 1. CAMPOS OBRIGATÓRIOS (Manual NFCom – Anexo II)
#############################################

# ---------------------------
# 1.1 Destinatário / Assinante / Fatura
# Manual: Nome, CNPJ/CPF/idOutros, Endereço, Nro Cliente, Vencimento,
# Total em Reais, Competência, Telefone Principal (se existir). :contentReference[oaicite:2]{index=2}
# ---------------------------

- id: R_DEST_XNOME_OBRIG
  descricao: "Nome do destinatário deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//dest/xNome"
  parametros: {}
  mensagem_erro: "Nome do destinatário não informado (dest/xNome)."
  sugestao_correcao: "Preencher o nome do destinatário conforme cadastro do assinante."
  nivel: "erro"

- id: R_DEST_ID_OBRIG
  descricao: "Identificação do destinatário (CNPJ/CPF/idOutros) deve estar preenchida"
  tipo: "obrigatorio"
  # Uso de união de caminhos: CNPJ ou CPF ou idOutros
  xpath: ".//dest/CNPJ | .//dest/CPF | .//dest/idOutros"
  parametros: {}
  mensagem_erro: "CNPJ/CPF/idOutros do destinatário não informado."
  sugestao_correcao: "Informar o CNPJ, CPF ou idOutros do destinatário conforme o caso."
  nivel: "erro"

- id: R_DEST_ENDERECO_OBRIG
  descricao: "Endereço completo do destinatário deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//dest/enderDest"
  parametros: {}
  mensagem_erro: "Endereço do destinatário (enderDest) não informado."
  sugestao_correcao: "Preencher o endereço completo do destinatário (sem indicação do país)."
  nivel: "erro"

- id: R_ASSINANTE_IDCOD_OBRIG
  descricao: "Código do assinante (assinante/idCodAssinante) deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//assinante/idCodAssinante"
  parametros: {}
  mensagem_erro: "idCodAssinante não informado para o assinante."
  sugestao_correcao: "Informar o código único do assinante (idCodAssinante) conforme cadastro."
  nivel: "erro"

- id: R_G_FAT_DVENC_OBRIG
  descricao: "Data de vencimento da fatura (gFat/dVencFat) deve estar preenchida"
  tipo: "obrigatorio"
  xpath: ".//gFat/dVencFat"
  parametros: {}
  mensagem_erro: "Data de vencimento da fatura (gFat/dVencFat) não informada."
  sugestao_correcao: "Preencher a data de vencimento da fatura conforme acordado com o assinante."
  nivel: "erro"

- id: R_G_FAT_COMPET_OBRIG
  descricao: "Competência da medição (gFat/CompetFat) deve estar preenchida"
  tipo: "obrigatorio"
  xpath: ".//gFat/CompetFat"
  parametros: {}
  mensagem_erro: "Competência da NFCom (gFat/CompetFat) não informada."
  sugestao_correcao: "Informar a competência da medição da NFCom (gFat/CompetFat)."
  nivel: "erro"

- id: R_TOTAL_VNF_OBRIG
  descricao: "Valor total da fatura (total/vNF) deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//total/vNF"
  parametros: {}
  mensagem_erro: "Valor total da fatura (total/vNF) não informado."
  sugestao_correcao: "Preencher o valor total da fatura no grupo total/vNF."
  nivel: "erro"

# ---------------------------
# 1.2 Identificação da NFCom / Protocolo / QR Code 
# ---------------------------

- id: R_IDE_NUMERO_OBRIG
  descricao: "Número da NFCom (ide/nNF) deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//ide/nNF"
  parametros: {}
  mensagem_erro: "Número da NFCom (ide/nNF) não informado."
  sugestao_correcao: "Preencher o número da NFCom no grupo ide/nNF."
  nivel: "erro"

- id: R_IDE_SERIE_OBRIG
  descricao: "Série da NFCom (ide/serie) deve estar preenchida"
  tipo: "obrigatorio"
  xpath: ".//ide/serie"
  parametros: {}
  mensagem_erro: "Série da NFCom (ide/serie) não informada."
  sugestao_correcao: "Preencher a série da NFCom no grupo ide/serie."
  nivel: "erro"

- id: R_IDE_DEMI_OBRIG
  descricao: "Data de emissão da NFCom (ide/dEmi) deve estar preenchida"
  tipo: "obrigatorio"
  xpath: ".//ide/dEmi"
  parametros: {}
  mensagem_erro: "Data de emissão da NFCom (ide/dEmi) não informada."
  sugestao_correcao: "Preencher a data de emissão (formato UTC) no grupo ide/dEmi."
  nivel: "erro"

- id: R_QRCOD_NFCOM_OBRIG
  descricao: "Conteúdo do QR Code da NFCom (qrCodNFCom) deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//qrCodNFCom"
  parametros: {}
  mensagem_erro: "Campo qrCodNFCom não informado."
  sugestao_correcao: "Gerar e informar o conteúdo do QR Code conforme especificação do MOC (tag qrCodNFCom)."
  nivel: "erro"

# ---------------------------
# 1.3 Itens do DANFE-COM (Divisão IV) :contentReference[oaicite:4]{index=4}
# Campos: xProd, uMed, qFaturada, vItem, vProd, PIS/vPIS, COFINS/vCOFINS,
# ICMS/vBC, ICMS/pICMS, ICMS/vICMS, indDevolucao.
# ---------------------------

- id: R_DET_XPROD_OBRIG
  descricao: "Descrição do item (prod/xProd) deve estar preenchida"
  tipo: "obrigatorio"
  xpath: ".//det/prod/xProd"
  parametros: {}
  mensagem_erro: "Descrição do item (prod/xProd) não informada."
  sugestao_correcao: "Informar a descrição do item conforme serviço prestado."
  nivel: "erro"

- id: R_DET_UMED_ALERTA
  descricao: "Unidade de medida (prod/uMed) deve ser informada quando o item for mensurável"
  tipo: "obrigatorio"
  xpath: ".//det/prod/uMed"
  parametros: {}
  mensagem_erro: "Unidade de medida (prod/uMed) não informada."
  sugestao_correcao: "Preencher a unidade de medida para itens mensuráveis."
  nivel: "alerta"

- id: R_DET_QFATURADA_OBRIG
  descricao: "Quantidade faturada (prod/qFaturada) deve estar preenchida"
  tipo: "obrigatorio"
  xpath: ".//det/prod/qFaturada"
  parametros: {}
  mensagem_erro: "Quantidade faturada (prod/qFaturada) não informada."
  sugestao_correcao: "Preencher a quantidade faturada no grupo prod/qFaturada."
  nivel: "erro"

- id: R_DET_VITEM_OBRIG
  descricao: "Valor unitário do item (prod/vItem) deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//det/prod/vItem"
  parametros: {}
  mensagem_erro: "Valor unitário (prod/vItem) não informado."
  sugestao_correcao: "Preencher o valor unitário do item em prod/vItem."
  nivel: "erro"

- id: R_DET_VPROD_OBRIG
  descricao: "Valor total do item (prod/vProd) deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//det/prod/vProd"
  parametros: {}
  mensagem_erro: "Valor total do item (prod/vProd) não informado."
  sugestao_correcao: "Preencher o valor total do item em prod/vProd."
  nivel: "erro"

- id: R_DET_PIS_VPIS_OBRIG
  descricao: "Valor de PIS (PIS/vPIS) deve estar preenchido quando houver PIS"
  tipo: "obrigatorio"
  xpath: ".//det/PIS/vPIS"
  parametros: {}
  mensagem_erro: "Valor de PIS (PIS/vPIS) não informado."
  sugestao_correcao: "Preencher o valor de PIS em PIS/vPIS, quando devido."
  nivel: "alerta"

- id: R_DET_COFINS_VCOFINS_OBRIG
  descricao: "Valor de COFINS (COFINS/vCOFINS) deve estar preenchido quando houver COFINS"
  tipo: "obrigatorio"
  xpath: ".//det/COFINS/vCOFINS"
  parametros: {}
  mensagem_erro: "Valor de COFINS (COFINS/vCOFINS) não informado."
  sugestao_correcao: "Preencher o valor de COFINS em COFINS/vCOFINS, quando devido."
  nivel: "alerta"

- id: R_DET_ICMS_VBC_OBRIG
  descricao: "Base de cálculo do ICMS (ICMS/vBC) deve estar preenchida quando houver ICMS"
  tipo: "obrigatorio"
  xpath: ".//det/ICMS/vBC"
  parametros: {}
  mensagem_erro: "Base de cálculo do ICMS (ICMS/vBC) não informada."
  sugestao_correcao: "Preencher o valor da base de cálculo do ICMS em ICMS/vBC."
  nivel: "erro"

- id: R_DET_ICMS_PICMS_OBRIG
  descricao: "Alíquota de ICMS (ICMS/pICMS) deve estar preenchida quando houver ICMS"
  tipo: "obrigatorio"
  xpath: ".//det/ICMS/pICMS"
  parametros: {}
  mensagem_erro: "Alíquota de ICMS (ICMS/pICMS) não informada."
  sugestao_correcao: "Informar a alíquota de ICMS aplicada ao item em ICMS/pICMS."
  nivel: "erro"

- id: R_DET_ICMS_VICMS_OBRIG
  descricao: "Valor de ICMS (ICMS/vICMS) deve estar preenchido quando houver ICMS"
  tipo: "obrigatorio"
  xpath: ".//det/ICMS/vICMS"
  parametros: {}
  mensagem_erro: "Valor de ICMS (ICMS/vICMS) não informado."
  sugestao_correcao: "Preencher o valor do ICMS em ICMS/vICMS."
  nivel: "erro"

# Regra textual do manual:
# se prod/indDevolucao indicar devolução, descrição deve conter o literal “Devolução”. :contentReference[oaicite:5]{index=5}
# OBS: com o motor genérico atual não conseguimos validar 'contém texto', então esta regra
# funciona apenas como lembrete (garante que xProd esteja preenchido quando indDevolucao=1).
- id: R_DET_DEVOLUCAO_DESC_ALERTA
  descricao: "Itens marcados como devolução devem conter 'Devolução' na descrição (regra manual)"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "./prod/indDevolucao"
    condicao_valores: ["1"]       # ajustar conforme codificação utilizada para devolução
    alvo_xpath: "./prod/xProd"
    alvo_obrigatorio: true
  mensagem_erro: "Item marcado como devolução, verificar se a descrição contém '(Devolução)'."
  sugestao_correcao: "Adicionar '(Devolução)' na descrição do item xProd para itens devolvidos."
  nivel: "alerta"

##########################################
# 2. REGRAS INTERNAS DO ESCRITÓRIO (FISCAIS)
# CFOP, CRT, CST, CClass (SCM/SVA)
#
# Parte das regras mais complexas (PF/PJ não contribuinte e SVA com CFOP zerado)
# está implementada em Python (validate_cfop_pf_pj_nao_contrib, validate_sva_cfop_zero).
##########################################

# 2.1 Validações básicas de formato / existência

- id: R_CFOP_FORMATO
  descricao: "CFOP deve ter 4 dígitos numéricos"
  tipo: "regex"
  xpath: ".//det/CFOP"
  parametros:
    pattern: "^[0-9]{4}$"
  mensagem_erro: "CFOP fora do padrão de 4 dígitos numéricos."
  sugestao_correcao: "Verificar CFOP de acordo com a tabela oficial aplicável ao serviço de comunicação."
  nivel: "erro"

- id: R_CRT_OBRIGATORIO
  descricao: "Regime tributário do emitente (emit/CRT) deve estar preenchido"
  tipo: "obrigatorio"
  xpath: ".//emit/CRT"
  parametros: {}
  mensagem_erro: "Campo emit/CRT (regime tributário) não informado."
  sugestao_correcao: "Preencher o regime tributário do emitente (CRT) conforme cadastro da empresa."
  nivel: "erro"


# 2.2 CFOP por tipo de pessoa (checklist + regra interna PF/PJ)

# OBS: A regra CRÍTICA para PF e PJ NÃO CONTRIBUINTES (usar 5307/6307) foi
# implementada em Python (validate_cfop_pf_pj_nao_contrib). Este bloco abaixo
# é um exemplo auxiliar / complementar para PJ contribuinte.

- id: R_CFOP_PJ_CONTRIB_ALERTA
  descricao: "PJ contribuinte: CFOP preferencialmente 5303 (intra) ou 6303 (inter)"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    # A partir de det, subimos até dest/indIEDest; ajustar se necessário ao layout real
    condicao_xpath: "../../dest/indIEDest"
    # 1 = Contribuinte ICMS, 2 = Isento (ajustar conforme documentação da UF)
    condicao_valores: ["1", "2"]
    alvo_xpath: "./CFOP"
  mensagem_erro: "CFOP pode não estar coerente com PJ contribuinte (esperado 5303 ou 6303 conforme UF)."
  sugestao_correcao: "Para PJ contribuinte, usar 5303 (dentro do estado) ou 6303 (fora do estado), conforme checklist."
  nivel: "alerta"


# 2.3 Regras de REGIME NORMAL (Lucro Real / Presumido)
# Checklist: ICMS CST 00, Origem 0, PIS/COFINS CST 01. :contentReference[oaicite:6]{index=6}

- id: R_REGNORMAL_ICMS_CST
  descricao: "Regime Normal: ICMS CST deve ser 00 - Tributada Integralmente"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "../../emit/CRT"
    # Na NF-e: 3 costuma indicar Regime Normal; ajustar se sua NFCom usar outro código
    condicao_valores: ["3"]
    alvo_xpath: "./ICMS/CST"
    alvo_valor_esperado: "00"
  mensagem_erro: "Para Regime Normal, o CST de ICMS deveria ser 00 - Tributada Integralmente."
  sugestao_correcao: "Ajustar o CST de ICMS para 00 nos itens da NFCom do emitente em Regime Normal."
  nivel: "erro"

- id: R_REGNORMAL_ICMS_ORIGEM
  descricao: "Regime Normal: origem do ICMS (orig) deve ser 0 - Nacional"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "../../emit/CRT"
    condicao_valores: ["3"]
    alvo_xpath: "./ICMS/orig"
    alvo_valor_esperado: "0"
  mensagem_erro: "Para Regime Normal, a origem do ICMS recomendada é 0 (nacional)."
  sugestao_correcao: "Ajustar ICMS/orig para 0 - Nacional, salvo situações específicas de importação."
  nivel: "alerta"

- id: R_REGNORMAL_PIS_CST
  descricao: "Regime Normal: PIS CST deve ser 01 - Operação Tribútavel"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "../../emit/CRT"
    condicao_valores: ["3"]
    alvo_xpath: "./PIS/CST"
    alvo_valor_esperado: "01"
  mensagem_erro: "Para Regime Normal, o CST de PIS deveria ser 01 - Operação tributável."
  sugestao_correcao: "Ajustar o CST de PIS para 01, conforme parametrização padrão do regime normal."
  nivel: "erro"

- id: R_REGNORMAL_COFINS_CST
  descricao: "Regime Normal: COFINS CST deve ser 01 - Operação Tribútavel"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "../../emit/CRT"
    condicao_valores: ["3"]
    alvo_xpath: "./COFINS/CST"
    alvo_valor_esperado: "01"
  mensagem_erro: "Para Regime Normal, o CST de COFINS deveria ser 01 - Operação tributável."
  sugestao_correcao: "Ajustar o CST de COFINS para 01, conforme parametrização padrão do regime normal."
  nivel: "erro"


# 2.4 Regras de SIMPLES NACIONAL
# Checklist: ICMS CST 90 (alíquota 0), PIS/COFINS 49 ou 99 (alíquota 0). :contentReference[oaicite:7]{index=7}

- id: R_SIMPLES_ICMS_CST
  descricao: "Simples Nacional: ICMS CST recomendado é 90 - Outras Saídas (alíquota 0%)"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "../../emit/CRT"
    # Na NF-e: 1 e 2 são Simples Nacional (com/sem sublimite); ajustar se NFCom divergir
    condicao_valores: ["1", "2"]
    alvo_xpath: "./ICMS/CST"
    alvo_valor_esperado: "90"
  mensagem_erro: "Para Simples Nacional, o CST de ICMS recomendado é 90 - Outras Saídas (alíquota 0%)."
  sugestao_correcao: "Ajustar o CST de ICMS para 90 nos itens da NFCom em Simples Nacional, salvo exceções específicas."
  nivel: "alerta"

# NOTA: para PIS/COFINS no Simples, o checklist recomenda 49 ou 99 (alíquota 0%).
# Como há mais de um CST possível, é melhor implementar essa validação em Python
# ou ajustar o motor para aceitar múltiplos valores. Aqui deixamos apenas uma regra
# de alerta genérica para suporte manual.

- id: R_SIMPLES_PIS_COFINS_ALERTA
  descricao: "Simples Nacional: verificar se PIS/COFINS usam CST 49 ou 99 (outras saídas, alíquota 0%)"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "../../emit/CRT"
    condicao_valores: ["1", "2"]
    alvo_xpath: "./PIS/CST"
  mensagem_erro: "Para Simples Nacional, recomenda-se usar CST 49 ou 99 para PIS/COFINS (alíquota 0%)."
  sugestao_correcao: "Verificar CST de PIS/COFINS (preferencialmente 49 ou 99), conforme parametrização da empresa."
  nivel: "alerta"


# 2.5 Regras ilustrativas ligadas a CClass SVA (a regra efetiva está no Python)

# Exemplo ilustrativo: se cClass for SVA, CFOP deve ser 0000 (zerado).
# A regra real já está implementada em Python (validate_sva_cfop_zero) usando
# a lista de CClass SVA do cclass_config.yaml; aqui fica apenas espelho em YAML.

- id: R_SVA_CFOP_ZERO_EXEMPLO
  descricao: "Exemplo: Se cClass estiver na lista de SVA, CFOP deve ser 0000"
  tipo: "condicional"
  xpath: ".//det"
  parametros:
    condicao_xpath: "./serv/cClass"
    # Importante: alinhar com a lista real de SVA em cclass_config.yaml
    condicao_valores: ["1100101", "0400101", "0400301", "0600201", "0800601", "0600601"]
    alvo_xpath: "./CFOP"
    alvo_valor_esperado: "0000"
  mensagem_erro: "CFOP diferente de 0000 para item SVA (cClass SVA)."
  sugestao_correcao: "Ajustar CFOP para 0000 para itens classificados como SVA."
  nivel: "erro"
